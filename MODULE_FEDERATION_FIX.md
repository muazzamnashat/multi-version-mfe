MODULE FEDERATION - Dependency fix and troubleshooting
====================================================

This document records the dependency fixes and commands used to resolve a
Module Federation startup error in this repository. It explains the exact
changes made, why they were necessary, how to reproduce and verify the fix,
and suggested next steps.

Summary
-------

Problem observed
* When running `nx serve mfe` or `nx serve shell` you saw this error:

  TypeError: The 'compilation' argument must be an instance of Compilation

Root cause
* Multiple copies/versions of `webpack` were present in the `node_modules`
  tree. The Module Federation plugin (from `@angular-architects/module-federation`)
  and the Angular/Nx webpack runtime ended up using different webpack instances.
  This caused `instanceof`-style checks inside webpack/tapable to fail and threw
  the above TypeError.

What I changed
--------------

1. Cleaned and normalized `package.json` (root) so the dependency listing is
   consistent.

2. Ensured the repository resolves to a single webpack version by adding an npm
   override that forces `webpack@5.102.0` across the dependency tree. The final
   relevant entry in `package.json` is:

   ```json
   "overrides": {
     "webpack": "5.102.0"
   }
   ```

3. Reinstalled dependencies (clean install) to apply the override and remove
   duplicate webpack instances.

Files changed
* `package.json` â€” normalized `devDependencies` and added the `overrides` key.

Commands I ran (diagnostics + fix)
---------------------------------

1. Reproduce error

   nx serve mfe --port 4300

2. Inspect installed webpack versions

   npm ls webpack --depth=2

3. Remove installed packages and lockfile (clean state)

   rm -rf node_modules package-lock.json

4. Reinstall (after package.json fixes)

   npm install

Notes about commands
* I iteratively used `npm ls webpack` to locate duplicate webpack versions.
* After adding the override and reinstalling, `npm ls webpack` shows a single
  `webpack@5.102.0` is resolved for all consumers.

How I verified the fix
----------------------

1. Ran `npm ls webpack --depth=2` and confirmed only `webpack@5.102.0` is
   present (deduped/overridden) across the tree.

2. Started both apps:

   - `nx serve mfe --port 4300`
   - `nx serve shell --port 4200`

   The previous ModuleFederationPlugin TypeError no longer occurred and the
   apps started and served their `remoteEntry.js`/bundles normally.

Why the override was chosen
---------------------------

* The immediate issue was a webpack instance mismatch. The quickest and safest
  way to bring all parts of the toolchain (Angular build tooling, loaders,
  Module Federation plugin) onto the same webpack runtime was to pin/override
  the version at the top-level.

Recommendations and next steps
------------------------------

1. Commit the current `package-lock.json` and `package.json` (this ensures CI
   and other developers get the same resolved tree).

2. Consider upgrading your global Nx CLI or use the local Nx binary to avoid
   mismatch messages:

   - `npm i -g nx@<matching-version>` OR
   - use `npx nx ...` / run scripts that call the local `nx`.

3. Monitor `@angular-devkit/build-angular` or other tooling updates. If a
   future version requires a different webpack version, revisit the override
   strategy (either remove override if all tools align or pin to the new
   compatible version).

4. Optionally add a short developer note in the repo (this file) explaining
   why webpack is overridden, to avoid confusion for future contributors.

How to revert the override (if needed)
-------------------------------------

1. Remove the `overrides` section in `package.json`.
2. `rm -rf node_modules package-lock.json`
3. `npm install`

Commit message used
-------------------

fix: unify webpack to 5.102.0 to resolve ModuleFederationPlugin startup error

This commit normalizes root dependencies and forces a single webpack version
so the Module Federation plugin and the Angular/Nx build pipeline use the same
webpack runtime (fixes TypeError: The 'compilation' argument must be an instance of Compilation).

If you want any changes to the wording or additional details included, tell me
and I will update the file and amend the commit.

----

Generated by the fix procedure on Oct 5, 2025.
